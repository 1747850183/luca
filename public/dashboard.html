<!-- public/dashboard.html -->
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>å‘˜å·¥ç®¡ç†ç³»ç»Ÿ - æ§åˆ¶å°</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .logout-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 4px;
        }

        .logout-btn:hover {
            background-color: #b02b39;
        }

        /* è¡¨æ ¼æ ·å¼ */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        /* æ–°å¢è¡¨å•æ ·å¼ */
        .add-form {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        input {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .add-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 6px 15px;
            cursor: pointer;
            border-radius: 4px;
        }

        .add-btn:hover {
            background-color: #185e28;
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <h2>å‘˜å·¥ç®¡ç†åˆ—è¡¨</h2>
            <div>
                <span id="welcomeUser"></span>
                <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>
        </header>

        <!-- 1. æ–°å¢å‘˜å·¥è¡¨å• -->
        <div class="add-form">
            <strong>å‘˜å·¥ä¿¡æ¯ï¼š</strong>
            <input type="hidden" id="editId">
            <input type="text" id="newName" placeholder="å§“å" required>
            <input type="text" id="newPos" placeholder="èŒä½" required>
            <input type="number" id="newSalary" placeholder="è–ªèµ„" required>
            <button class="add-btn" id="saveBtn" onclick="handleSave()">æ·»åŠ </button>
            <button id="cancelBtn" onclick="cancelEdit()"
                style="display:none; margin-left:5px;cursor:pointer; border-radius:4px;">å–æ¶ˆ</button>
        </div>

        <!-- 2. æ•°æ®åˆ—è¡¨è¡¨æ ¼ -->
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>å§“å</th>
                    <th>èŒä½</th>
                    <th>è–ªèµ„</th>
                    <th>å…¥èŒæ—¶é—´</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="employeeTableBody">
                <!-- è¿™é‡Œçš„æ•°æ®ä¼šç”± JS è‡ªåŠ¨å¡«å…… -->
            </tbody>
        </table>
    </div>

    <script>
        // ===========================
        // 1. å®‰å…¨æ£€æŸ¥ (å®ˆå«)
        // ===========================
        const user = localStorage.getItem('user');
        if (!user) {
            alert('ä½ è¿˜æ²¡ç™»å½•å‘¢ï¼');
            window.location.href = '/index.html'; // è¸¢å›é¦–é¡µ
        }
        document.getElementById('welcomeUser').textContent = `ä½ å¥½, ${user} | `;

        // ===========================
        // 2. æ ¸å¿ƒåŠŸèƒ½ï¼šåŠ è½½åˆ—è¡¨
        // ===========================
        async function loadEmployees() {
            try {
                // å‘åç«¯å‘èµ· GET è¯·æ±‚
                const res = await fetch('/api/employees');
                const json = await res.json();

                if (json.success) {
                    const tbody = document.getElementById('employeeTableBody');
                    tbody.innerHTML = ''; // å…ˆæ¸…ç©ºè¡¨æ ¼ï¼Œé˜²æ­¢é‡å¤

                    // éå†æ•°æ®ï¼Œç”Ÿæˆ HTML
                    json.data.forEach(emp => {
                        const date = new Date(emp.created_at).toLocaleString(); // æ ¼å¼åŒ–æ—¶é—´

                        const tr = `
                            <tr>
                                <td>${emp.id}</td>
                                <td>${emp.name}</td>
                                <td>${emp.position}</td>
                                <td>Â¥${emp.salary}</td>
                                <td>${date}</td>
                                <td>
                                    <button onclick="startEdit(${emp.id}, '${emp.name}', '${emp.position}', ${emp.salary})" style="background:#305CED; color:white;border:none; padding:5px 10px; cursor:pointer; border-radius:4px;">ç¼–è¾‘</button>
                                    <button onclick="deleteEmployee(${emp.id})" style="background:#dc3545; color:white; border:none; padding:5px 10px; cursor:pointer; border-radius:4px; margin-left:5px;">åˆ é™¤</button>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += tr; // è¿½åŠ åˆ°è¡¨æ ¼é‡Œ
                    });
                }
            } catch (err) {
                console.error('åŠ è½½å¤±è´¥', err);
                alert('è·å–æ•°æ®å¤±è´¥');
            }
        }

        // ===========================
        // 3. æ ¸å¿ƒåŠŸèƒ½ï¼šæ·»åŠ å‘˜å·¥
        // ===========================
        async function handleSave() {
            const id = document.getElementById('editId').value; // çœ‹çœ‹æœ‰æ²¡æœ‰ ID
            const name = document.getElementById('newName').value;
            const position = document.getElementById('newPos').value;
            const salary = document.getElementById('newSalary').value;

            if (!name || !position || !salary) {
                alert('è¯·æŠŠä¿¡æ¯å¡«å®Œæ•´');
                return;
            }

            const data = { name, position, salary };

            // å¦‚æœ id å­˜åœ¨ï¼Œè¯´æ˜æ˜¯ã€ä¿®æ”¹æ¨¡å¼ã€‘
            if (id) {
                data.id = id;
                await fetch('/api/employees', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                alert('ä¿®æ”¹æˆåŠŸï¼');
            } else {
                // å¦‚æœ id ä¸å­˜åœ¨ï¼Œè¯´æ˜æ˜¯ã€æ–°å¢æ¨¡å¼ã€‘
                await fetch('/api/employees', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                alert('æ·»åŠ æˆåŠŸï¼');
            }

            // é‡ç½®è¡¨å•å¹¶åˆ·æ–°åˆ—è¡¨
            cancelEdit();
            loadEmployees();
        }
        // 4. å¼€å§‹ç¼–è¾‘ï¼ˆç‚¹å‡»è¡¨æ ¼é‡Œçš„ç¼–è¾‘æŒ‰é’®ï¼‰
        function startEdit(id, name, pos, salary) {
            // æŠŠæ•°æ®å¡«å›ä¸Šé¢çš„è¾“å…¥æ¡†
            document.getElementById('editId').value = id;
            document.getElementById('newName').value = name;
            document.getElementById('newPos').value = pos;
            document.getElementById('newSalary').value = salary;

            // æ”¹å˜æŒ‰é’®æ–‡å­—
            document.getElementById('saveBtn').textContent = 'ä¿å­˜ä¿®æ”¹';
            document.getElementById('saveBtn').style.backgroundColor = '#305CED'; // å˜é»„
            document.getElementById('cancelBtn').style.display = 'inline-block'; // æ˜¾ç¤ºå–æ¶ˆæŒ‰é’®
        }
        // 5. å–æ¶ˆç¼–è¾‘
        function cancelEdit() {
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('editId').value = '';
            document.getElementById('newName').value = '';
            document.getElementById('newPos').value = '';
            document.getElementById('newSalary').value = '';

            // æ¢å¤æŒ‰é’®çŠ¶æ€
            document.getElementById('saveBtn').textContent = 'æ·»åŠ ';
            document.getElementById('saveBtn').style.backgroundColor = '#28a745'; // å˜ç»¿
            document.getElementById('cancelBtn').style.display = 'none';
        }
        // 6. åˆ é™¤å‘˜å·¥
        async function deleteEmployee(id) {
            if (!confirm('ç¡®å®šè¦å¼€é™¤è¿™ä½å‘˜å·¥å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼')) return;

            try {
                // å‘é€ DELETE è¯·æ±‚ï¼Œæ³¨æ„å‚æ•°å†™åœ¨ URL é‡Œ
                const res = await fetch(`/api/employees?id=${id}`, {
                    method: 'DELETE'
                });
                const json = await res.json();

                if (json.success) {
                    alert('åˆ é™¤æˆåŠŸ');
                    loadEmployees(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + json.error);
                }
            } catch (err) {
                console.error(err);
                alert('ç½‘ç»œé”™è¯¯');
            }
        }
        // 7. é€€å‡º
        function logout() {
            localStorage.removeItem('user');
            window.location.href = '/index.html';
        }

        // é¡µé¢ä¸€æ‰“å¼€ï¼Œç«‹åˆ»åŠ è½½æ•°æ®
        loadEmployees();

    </script>
    <div id="chat-btn" onclick="toggleChat()"
        style="position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: #007bff; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); font-size: 30px;">
        ğŸ¤–
    </div>

    <!-- 2. èŠå¤©çª—å£ (é»˜è®¤éšè—) -->
    <div id="chat-window"
        style="display: none; position: fixed; bottom: 90px; right: 20px; width: 350px; height: 500px; background: white; border: 1px solid #ccc; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); flex-direction: column;">
        <!-- æ ‡é¢˜æ  -->
        <div
            style="background: #007bff; color: white; padding: 10px; border-radius: 10px 10px 0 0; display: flex; justify-content: space-between;">
            <span>AI æ•°æ®åŠ©ç†</span>
            <span onclick="toggleChat()" style="cursor: pointer;">âœ–</span>
        </div>

        <!-- æ¶ˆæ¯å†…å®¹åŒº -->
        <div id="chat-messages"
            style="flex: 1; padding: 10px; overflow-y: auto; background: #f9f9f9; display: flex; flex-direction: column; gap: 10px;">
            <div style="background: #e9ecef; padding: 8px; border-radius: 5px; align-self: flex-start; max-width: 80%;">
                ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„æ•°æ®åŠ©ç†
            </div>
        </div>

        <!-- è¾“å…¥æ¡†åŒº -->
        <div style="padding: 10px; border-top: 1px solid #eee; display: flex;">
            <input type="text" id="chat-input" placeholder="è¾“å…¥é—®é¢˜..."
                style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <button onclick="sendMsg()"
                style="margin-left: 5px; background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">å‘é€</button>
        </div>
    </div>

    <script>
        // åˆ‡æ¢èŠå¤©çª—æ˜¾ç¤º/éšè—
        function toggleChat() {
            const win = document.getElementById('chat-window');
            if (win.style.display === 'none') {
                win.style.display = 'flex';
            } else {
                win.style.display = 'none';
            }
        }

        // å‘é€æ¶ˆæ¯
        async function sendMsg() {
            const input = document.getElementById('chat-input');
            const msg = input.value;
            if (!msg) return;

            // 1. æŠŠè‡ªå·±çš„è¯æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Š
            addBubble(msg, 'self');
            input.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†

            // 2. æ˜¾ç¤ºâ€œæ­£åœ¨æ€è€ƒ...â€
            const loadingId = addBubble('æ­£åœ¨æ€è€ƒ...', 'system');

            try {
                // 3. å‘é€ç»™åç«¯
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg })
                });
                const json = await res.json();

                // 4. ç§»é™¤â€œæ­£åœ¨æ€è€ƒâ€ï¼Œæ˜¾ç¤º AI çš„å›ç­”
                document.getElementById(loadingId).remove();

                if (json.success) {
                    addBubble(json.reply, 'ai');
                    if (json.shouldRefresh) {
                        console.log("æ£€æµ‹åˆ°æ•°æ®å˜åŠ¨ï¼Œæ­£åœ¨è‡ªåŠ¨åˆ·æ–°åˆ—è¡¨...");
                        loadEmployees();
                    }
                } else {
                    addBubble('å‡ºé”™äº†: ' + json.error, 'system');
                }

            } catch (err) {
                addBubble('ç½‘ç»œè¿ä¸ä¸Šäº†', 'system');
            }
        }

        // è¾…åŠ©å‡½æ•°ï¼šæ·»åŠ æ°”æ³¡
        function addBubble(text, type) {
            const box = document.getElementById('chat-messages');
            const div = document.createElement('div');
            const id = 'msg-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
            div.id = id;
            div.style.padding = '8px';
            div.style.borderRadius = '5px';
            div.style.maxWidth = '80%';
            div.style.wordWrap = 'break-word';

            if (type === 'self') {
                div.style.background = '#007bff';
                div.style.color = 'white';
                div.style.alignSelf = 'flex-end'; // é å³
            } else if (type === 'ai') {
                div.style.background = '#e9ecef';
                div.style.color = 'black';
                div.style.alignSelf = 'flex-start'; // é å·¦
            } else {
                div.style.background = 'transparent';
                div.style.color = '#888';
                div.style.fontSize = '12px';
                div.style.alignSelf = 'center';
            }

            div.textContent = text;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight; // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            return id;
        }

        // æ”¯æŒæŒ‰å›è½¦å‘é€
        document.getElementById('chat-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') sendMsg();
        });
    </script>
</body>

</html>